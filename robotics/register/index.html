<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Robotics Club - MNNIT Allahabad</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="./style.css">
  <link href="https://fonts.googleapis.com/css?family=Kaushan+Script" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Berkshire+Swash" rel="stylesheet">
</head>
<body class="auth-false">
  <div class="container">
    <header class="clearfix" style="background: linear-gradient(to right, #2980b9, #6dd5fa, #ffffff);border-radius:5px;">
	<div class="row">
		<div class="col-lg-3 col-md-3 col-sm-offset-4 col-sm-4 col-xs-offset-5 col-xs-1">
		 <img class=".d-none"src="../logo.png" alt="MNNIT Allahabad"  style="width:20%;display: block;margin-left: auto;margin-right: auto;margin-top:8px;">
		 </div>
		 <div class="col-lg-5 col-md-5  col-sm-offset-4 col-sm-4 col-xs-offset-5 col-xs-1">
		 <center>
		  <h1 style="font-family: 'Kaushan Script', cursive;font-weight:100;text-align:center;">Robotics Club</h1></center>
		  <!-- <img src="../img/menu-logo.png" alt="ProSang"  style="width:40%;display: block;margin-left: auto; margin-right: auto;" >-->
		 </div>
		  <div class="col-lg-4 col-md-4 col-sm-12 col-xs-8">
		 <div class="userAuth unauthenticated pull-right">
			
				<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#registerModal">Register</button>
				<button type="button" class="btn btn-success" data-toggle="modal" data-target="#loginModal">Login</button>
			</div>
		 
		 <div class="userAuth authenticated pull-right">
			
			<span class="user-info">
			  <img src="user.svg" alt="User" class="rounded-circle" >
			</span>
			<button type="button" class="btn btn-success" id="logout">Logout</button>
		 </div>
		 </div>
	 </div>
    </header>
    <hr/>
	<main class="unauthenticated">
      <div class="row">
		  
			<div class="col-lg-10 col-md-10 col-sm-10 col-xs-10" >
				<center>
					<img src="../img/soon.png" alt="Registrations Starting Soon" style="display: block;margin-left: auto; margin-right: auto;">
				</center>
			</div>
			
	  </div>
    </main>
  
    <main class="authenticated">
      <div class="row">
		  
			<div class="col-lg-4 col-md-10 col-md-offset-1  col-sm-10 col-sm-offset-1 col-xs-10 col-xs-offset-1" >
				<br/><center>
			    <span class="user-info" style="display: inline-block;margin: 0 0.5em; font-family: 'Berkshire Swash', cursive;font-size:26px;">
				  <img src="user.svg" alt="User" style="width:70%;max-width:80em;border-radius:10%;" >
			    </span>
			  
			    <hr/>
			    <br/>
					 
				
				</center>
			</div>
			
			<div class="col-lg-6 col-md-10 col-md-offset-1  col-sm-10 col-sm-offset-1 col-xs-10 col-xs-offset-1" >
				<center>
					<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addProjectModal">Add Project</button>
				
					<br/>
					<div id="projects" ></div>
				</center>
			</div>
			<div class="col-lg-2 col-md-10 col-md-offset-1  col-sm-10 col-sm-offset-1 col-xs-10 col-xs-offset-1" >
				<center>
					<!--<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addinfoModal">Additional Info</button>-->
					<hr/>
					<br/>
						
					<div class="file-upload">
					  <div class="file-select">
						<div class="file-select-button" id="fileName">Upload Pic</div>
						<div class="file-select-name" id="noFile">...</div> 
						<input type="file" name="file" id="file" accept="image/*">
					  </div>
					</div>
					<span id="linkbox"></span>
					<!--<div id="filesubmit" >
							<input type="file" class="file-select" id="file" name="file"  accept="image/*"/>			
						<span id="linkbox"></span>
					</div>-->
				</center>
			</div>
			
	  </div>
    </main>
  </div>

  <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="Register" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="registerForm" method="POST">
          <div class="modal-header">
            <h4 class="modal-title" id="registerModalLabel">Register</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="recipient-name" class="control-label">First Name:</label>
              <input type="text" class="form-control" id="registerFirstName">
            </div>
            <div class="form-group">
              <label for="recipient-name" class="control-label">Last Name:</label>
              <input type="text" class="form-control" id="registerLastName">
            </div>
            <div class="form-group">
              <label for="recipient-name" class="control-label">Email:</label>
              <input type="text" class="form-control" id="registerEmail">
            </div>
            <div class="form-group">
              <label for="message-text" class="control-label">Password:</label>
              <input type="password" class="form-control" id="registerPassword">
            </div>
            <div class="form-group">
              <label for="message-text" class="control-label">Confirm Password:</label>
              <input type="password" class="form-control" id="registerConfirmPassword">
            </div>
          </div>
		  
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" id="doRegister">Register</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="Login" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="loginForm" method="POST">
          <div class="modal-header">
            <h4 class="modal-title" id="loginModalLabel">Login</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="recipient-name" class="control-label">Email:</label>
              <input type="text" class="form-control" id="loginEmail">
            </div>
            <div class="form-group">
              <label for="message-text" class="control-label">Password:</label>
              <input type="password" class="form-control" id="loginPassword">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary" id="doLogin">Login</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="addProjectModal" tabindex="-1" role="dialog" aria-labelledby="Add Contact" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" id="projectForm" name="projectForm">
          <div class="modal-header">
            <h4 class="modal-title" id="addProjectModalLabel">Add Project</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="name">Title</label>
              <input type="text" class="form-control" id="name" required placeholder="Enter Title">
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" class="form-control" id="email" required placeholder="Enter Email">
            </div>
            <h3>About</h3>
            <div class="form-group">
              <label for="city">Subject</label>
              <input type="text" class="form-control" id="subject" placeholder="Enter Subject">
            </div>
            <div class="form-group">
              <label for="email">Description</label>
              <input type="text" class="form-control" id="description" placeholder="Enter Description">
            </div>
            <div class="form-group">
              <label for="zip">Github</label>
              <input type="text" class="form-control" id="github" placeholder="username/repo">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary addValue">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!--AddInfo Form -->
  <div class="modal fade" id="addinfoModal" tabindex="-1" role="dialog" aria-labelledby="Additional Information" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form method="POST" id="addinfoForm" name="addinfoForm">
          <div class="modal-header">
            <h4 class="modal-title" id="addinfoModalLabel">Additional Information</h4>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" class="form-control" id="email" required placeholder="Enter Email">
            </div>
            <div class="form-group">
              <label for="city">Subject</label>
              <input type="text" class="form-control" id="subject" placeholder="Enter Subject">
            </div>
            <div class="form-group">
              <label for="email">Description</label>
              <input type="text" class="form-control" id="description" placeholder="Enter Description">
            </div>
            <div class="form-group">
              <label for="zip">Github</label>
              <input type="text" class="form-control" id="github" placeholder="username">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-primary addValue">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  
  <div class="modal fade" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="Message" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="messageModalLabel">Message</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-footer">
          <div class="pre-auth">
            <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
            <span class="">
              <button type="submit" class="btn btn-primary" data-dismiss="modal" data-toggle="modal" data-target="#registerModal">Register</button>
              <button type="submit" class="btn btn-success" data-dismiss="modal" data-toggle="modal" data-target="#loginModal">Login</button>
            </span>
          </div>
          <div class="post-auth"></div>
        </div>
      </div>
    </div>
  </div>
  
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
$(document).ready(function(){
  //initialize the firebase app
  var config = {
    apiKey: "AIzaSyDTucqwOg9vP6psm1F0yllUIE7ugzNbVRo",
    authDomain: "prosang-web.firebaseapp.com",
    databaseURL: "https://prosang-web.firebaseio.com",
    projectId: "prosang-web",
    storageBucket: "prosang-web.appspot.com",
    messagingSenderId: "1091756402670"
  };
  firebase.initializeApp(config);


  
  //create firebase references
  var Auth = firebase.auth(); 
  var dbRef = firebase.database();
  var projectsRef = dbRef.ref('projects')
  var usersRef = dbRef.ref('users')
  var addinfoRef = dbRef.ref('addinfo')
  var storageRef = firebase.storage().ref();
  var auth = null;

  document.getElementById('file').addEventListener('change', handleFileSelect, false);
  document.getElementById('file').disabled = true;
   
  
  
  //Register
  $('#registerForm').on('submit', function (e) {
    e.preventDefault();
    $('#registerModal').modal('hide');
    $('#messageModalLabel').html(spanText('<i class="fa fa-cog fa-spin"></i>', ['center', 'info']));
    $('#messageModal').modal('show');
    var data = {
      email: $('#registerEmail').val(), //get the email from Form
      firstName: $('#registerFirstName').val(), // get firstName
      lastName: $('#registerLastName').val(), // get lastName
    };
    var passwords = {
      password : $('#registerPassword').val(), //get the pass from Form
      cPassword : $('#registerConfirmPassword').val(), //get the confirmPass from Form
    }
    if( data.email != '' && passwords.password != ''  && passwords.cPassword != '' ){
      if( passwords.password == passwords.cPassword ){
        //create the user
        
        firebase.auth().createUserWithEmailAndPassword(data.email, passwords.password)
			  
			.then(function() {
			  var user = firebase.auth().currentUser;
				firebase.database().ref('users/'+user.uid).set({
				   displayName: data.firstName + ' ' + data.lastName
				})
            return user.updateProfile({
              displayName: data.firstName + ' ' + data.lastName
            })
          })
          .then(function(){
            //now user is needed to be logged in to save data
			var user = firebase.auth().currentUser;
            auth = user;
            //now saving the profile data
            usersRef.child(user.uid).set(data)
              .then(function(){
                console.log("User Information Saved:", user.uid);
              })
            $('#messageModalLabel').html(spanText('Success!', ['center', 'success']))
            
            $('#messageModal').modal('hide');
          })
          .catch(function(error){
			  
            console.log("Error creating user:", error);
            $('#messageModalLabel').html(spanText('ERROR: '+error.code, ['danger']))
          });
      } else {
        //password and confirm password didn't match
        $('#messageModalLabel').html(spanText("ERROR: Passwords didn't match", ['danger']))
      }
    }  
  });

  //Login
  $('#loginForm').on('submit', function (e) {
    e.preventDefault();
    $('#loginModal').modal('hide');
    $('#messageModalLabel').html(spanText('<i class="fa fa-cog fa-spin"></i>', ['center', 'info']));
    $('#messageModal').modal('show');

    if( $('#loginEmail').val() != '' && $('#loginPassword').val() != '' ){
      //login the user
      var data = {
        email: $('#loginEmail').val(),
        password: $('#loginPassword').val()
      };
      firebase.auth().signInWithEmailAndPassword(data.email, data.password)
        .then(function(authData) {
          auth = authData;
          $('#messageModalLabel').html(spanText('Success!', ['center', 'success']))
          $('#messageModal').modal('hide');
        })
        .catch(function(error) {
          console.log("Login Failed!", error);
          $('#messageModalLabel').html(spanText('ERROR: '+error.code, ['danger']))
        });
    }
  });

  $('#logout').on('click', function(e) {
    e.preventDefault();
    firebase.auth().signOut()
  });

  //save project
  $('#projectForm').on('submit', function( event ) {  
    event.preventDefault();
	$('#addProjectModal').modal('hide');
    if( auth != null ){
      if( $('#name').val() != '' || $('#email').val() != '' ){
        projectsRef.child(auth.uid)
          .push({
            name: $('#name').val(),
            email: $('#email').val(),
            location: {
              subject: $('#subject').val(),
              description: $('#description').val(),
              github: $('#github').val()
            }
          })
          document.projectForm.reset();
      } else {
        alert('Please fill at-lease name or email!');
      }
    } else {
      //location user to login
    }
  });

  
  //Filepload
  function handleFileSelect(evt) {
      evt.stopPropagation();
      evt.preventDefault();
      var file = evt.target.files[0];
	  var authuser = firebase.auth().currentUser;
      var metadata = {
        'contentType': file.type
      };

      // Push to child path.
      // [START oncomplete]
      storageRef.child('images/' + file.name).put(file, metadata).then(function(snapshot) {
        console.log('Uploaded', snapshot.totalBytes, 'bytes.');
        console.log('File metadata:', snapshot.metadata);
        // Let's get a download URL for the file.
        snapshot.ref.getDownloadURL().then(function(url) {
          console.log('File available at', url);
          // [START_EXCLUDE]
          document.getElementById('linkbox').innerHTML = '<a href="'+url+'">View</a>';
		 
		
		  if( auth != null ){
				usersRef.child(auth.uid)
				  .update({
					photoUrl :url
				  })
			} else {
			  //location user to login
			}
          // [END_EXCLUDE]
        });
      }).catch(function(error) {
        // [START onfailure]
        console.error('Upload failed:', error);
        // [END onfailure]
      });
      // [END oncomplete]
	  usersRef.child(auth.uid).once('value').then(function (data) {
			var info = data.val();
			if(info.photoUrl) {
				$('.user-info img').show();
				$('.user-info img').attr('src', info.photoUrl);
			}
		});
    }
  
   //save addinfo
  $('#addinfoForm').on('submit', function( event ) {  
    event.preventDefault();
    if( auth != null ){
      if($('#email').val() != '' ){
        addinfoRef.child(auth.uid)
          .push({
            email: $('#email').val(),
            institute: $('#institute').val(),
            dob: $('#dob').val(),
            github: $('#github').val()
          })
          document.projectForm.reset();
      } else {
        alert('Please fill at-lease name or email!');
      }
    } else {
      //location user to login
    }
  });
  
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      auth = user;
      $('body').removeClass('auth-false').addClass('auth-true');
	  
	  console.log('user signed-in.');
      document.getElementById('file').disabled = false;
	  
	  var pic
	  
      usersRef.child(user.uid).once('value').then(function (data) {
        var info = data.val();
		
        if(info.photoUrl) {
			console.log("1a");
          $('.user-info img').show();
          $('.user-info img').attr('src', info.photoUrl);
          $('.user-info .user-name').hide();
        } else if(user.displayName) {
		console.log("2a");
          $('.user-info img').show();
          $('.user-info').append('<span class="user-name" >'+user.displayName+'</span>');
        } else if(info.firstName) {
		console.log("3a");
          $('.user-info img').show();
          $('.user-info').append('<span class="user-name">'+info.firstName+'</span>');
        }
		if(info.githubLink){
			console.log(info.githubLink);
			console.log('<div id="github-card" data-username="khitk9738"> </div>');
			//$('#gituser').append('<div class="github-card" data-github="khitk9738" data-width="400" data-height="400" data-theme="medium"></div>bhhhhhhjhj');
			//$('.gituser').append('<div id="github-card" data-username="khitk9738"> </div>');
			//document.getElementById("gituser").innerHTML="<div id=\"github-card\" data-username=\"khitk9738\"> </div>";
		}
      });
      projectsRef.child(user.uid).on('child_added', onChildAdd);
	  
    } else {
      // No user is signed in.
      $('body').removeClass('auth-true').addClass('auth-false');
	  // $('#projects').append('<div class="row">');
      auth && projectsRef.child(auth.uid).off('child_added', onChildAdd);
	   //$('#projects').append('</div>');
      $('#projects').html('');
      auth = null;
    }
  });
});

function onChildAdd (snap) {
  $('#projects').append(projectHtmlFromObject(snap.key, snap.val()));
}


 
//prepare project object's HTML
function projectHtmlFromObject(key, project){
  return '<div class="card project" style="width:90%;" id="'+key+'">'
    + '<div class="card-body">'
      + '<h5 class="card-title">'+project.name+'</h5>'
      + '<h6 class="card-subtitle mb-2 text-muted">'+project.email+'</h6>'
      + '<p class="card-text" title="' + project.location.github+'">'
        + project.location.subject + '<br/> '
        + project.location.description +'<br/> '
		+ project.location.github
      + '</p>'
      // + '<a href="#" class="card-link">Card link</a>'
      // + '<a href="#" class="card-link">Another link</a>'
    + '</div>'
  +'</div>';
}


function spanText(textStr, textClasses) {
  var classNames = textClasses.map(c => 'text-'+c).join(' ');
  return '<span class="'+classNames+'">'+ textStr + '</span>';
}

$('#chooseFile').bind('change', function () {
  var filename = $("#chooseFile").val();
  if (/^\s*$/.test(filename)) {
    $(".file-upload").removeClass('active');
    $("#noFile").text("No file chosen..."); 
  }
  else {
    $(".file-upload").addClass('active');
    $("#noFile").text(filename.replace("C:\\fakepath\\", "")); 
  }
});

</script>
  
  <script src="//cdn.jsdelivr.net/github-cards/latest/widget.js"></script>

 <!-- <link rel="stylesheet" href="http://github-profile.com/dist/gh-profile-card.min.css" />
<script type="text/javascript" src="http://github-profile.com/dist/gh-profile-card.min.js"></script>-->
  
  <!--<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/5.8.4/firebase.js"></script>
 
  <!-- Projects Store JavaScript 
  <script src="./script.js"></script>-->
</body>
</html>
